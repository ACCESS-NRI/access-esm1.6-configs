#PBS -l walltime=1000
#PBS -q normalsr
#PBS -l ncpus=416
#PBS -l mem=832GB
#PBS -l jobfs=2gb
#PBS -l storage=gdata/vk83
#PBS -l wd

module use /g/data/vk83/modules
module load access-esm1p6/2025.07.000
module load openmpi

set -u

# Environment variables
export UM_ATM_NPROCX=16
export UM_ATM_NPROCY=13
(( UM_NPES = $UM_ATM_NPROCX * $UM_ATM_NPROCY ))
export UM_NPES
OCN_NPROCX=14
OCN_NPROCY=14
(( OCN_NPES = $OCN_NPROCX * $OCN_NPROCY ))
export OCN_NPES

# Set run length
export NDAYS=1
(( NSECONDS = $NDAYS * 86400 ))
export NSECONDS
(( NHOURS = $NDAYS * 24 ))
export NHOURS

export AINITIAL=''
export ASTART=INPUT/restart_dump.astart
export AUSCOM_CPL='true'
export DATAW=$PWD/work
export FASTRUN='true'
export IDEALISE=''
export PAREXE=''
export PRINT_STATUS=PrStatus_Diag
export RPSEED=''
export RUNID=PI-02
export TYPE=NRUN
export UM_NAM_MAX_SECONDS=300
export UM_SECTOR_SIZE=2048
export UM_STDOUT_FILE=atm.fort6.pe
export VN='7.3'

# Config input paths
export UNIT01=''
export UNIT02=prefix
export UNIT04=STASHC
export UNIT05=namelists
export UNIT07=PI-01.out2
export UNIT08=/dev/null
export UNIT09=CONTCNTL
export UNIT10=xhist
export UNIT11=ihist
export UNIT12=thist
export UNIT14=errflag
export UNIT15=''
export UNIT58=''
export UNIT22=INPUT/STASHmaster
export UNIT57=INPUT/spec3a_sw_hadgem1_6on
export UNIT80=INPUT/spec3a_lw_hadgem1_6on
export STASETS_DIR=INPUT/stasets
export VERT_LEV=INPUT/vertlevs_G3

# Ancillary files
export ARCLBIOG=INPUT/biogenic_351sm.N96L38
export BIOMASS=INPUT/Bio_1850_cmip7.anc
export CHEMOXID=INPUT/sulpc_oxidants_N96_L38
export DMSCONC=INPUT/DMS_conc.N96
export NDEPFIL=INPUT/Ndep_1850_ESM1.anc
export OCFFEMIS=INPUT/OCFF_1850_cmip7.anc
export OZONE=INPUT/ozone_1850_ESM1.anc
export SOOTEMIS=INPUT/BC_1850_cmip7.anc
export SULPEMIS=INPUT/scycl_1850_cmip7.anc
export VEGINIT=INPUT/cable_vegfunc_N96.anc

export TOPDIR=$PWD
export WORKDIR=$PWD/work

RESTART_DIR=/g/data/vk83/prerelease/configurations/inputs/access-esm1p6/modern/pre-industrial/restart/2025.08.01

mkdir -p $WORKDIR/coupler
cd $WORKDIR/coupler
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/coupler/remapping_weights/global.oi_1deg.a_N96/2025.08.06/* .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/coupler/grids/global.oi_1deg.a_N96/2025.07.29/* .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/coupler/grids/global.oi_1deg.a_N96/2020.05.19/masks.nc .
# Coupler restarts are modified in place, hence must be copied rather than linked
cp -r $RESTART_DIR/coupler/* .
ln -sf $TOPDIR/coupler/* .
rm namcouple
sed "s/NSECONDS/$NSECONDS/" $TOPDIR/coupler/namcouple > namcouple

mkdir -p $WORKDIR/atmosphere/INPUT
cd $WORKDIR/atmosphere/INPUT

# Aerosols
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/modern/pre-industrial/atmosphere/aerosol/global.N96/2025.06.04/OCFF_1850_cmip7.anc .
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/modern/pre-industrial/atmosphere/aerosol/global.N96/2025.06.04/BC_1850_cmip7.anc .
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/modern/pre-industrial/atmosphere/aerosol/global.N96/2025.06.04/scycl_1850_cmip7.anc .
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/modern/pre-industrial/atmosphere/aerosol/global.N96/2025.06.04/Bio_1850_cmip7.anc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/atmosphere/aerosol/global.N96/2020.05.19/biogenic_351sm.N96L38 .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/atmosphere/aerosol/global.N96/2020.05.19/sulpc_oxidants_N96_L38 .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/atmosphere/aerosol/global.N96/2020.05.19/DMS_conc.N96 .
# Forcing
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/pre-industrial/atmosphere/forcing/global.N96/2020.05.19/ozone_1850_ESM1.anc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/pre-industrial/atmosphere/forcing/resolution_independent/2020.05.19/volcts_18502000ave.dat .
# Land
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/pre-industrial/atmosphere/land/biogeochemistry/global.N96/2020.05.19/Ndep_1850_ESM1.anc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/atmosphere/land/soiltype/global.N96/2020.05.19/qrparm.soil_igbp_vg .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/atmosphere/land/vegetation/global.N96/2020.05.19/cable_vegfunc_N96.anc .
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/share/atmosphere/land/biogeochemistry/resolution_independent/2025.06.06/modis_phenology_csiro_nophase.txt .
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/share/atmosphere/land/biogeochemistry/resolution_independent/2024.12.18/pftlookup_cable3.csv .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/share/atmosphere/land/biogeophysics/resolution_independent/2020.05.19/def_soil_params.txt .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/share/atmosphere/land/biogeophysics/resolution_independent/2020.05.19/def_veg_params.txt .
# Spectral
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/share/atmosphere/spectral/resolution_independent/2020.05.19/spec3a_sw_hadgem1_6on .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/share/atmosphere/spectral/resolution_independent/2020.05.19/spec3a_lw_hadgem1_6on .
# Grids
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/atmosphere/grids/global.N96/2020.05.19/qrparm.mask .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/share/atmosphere/grids/resolution_independent/2020.05.19/vertlevs_G3 .
# STASH
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/share/atmosphere/stash/2020.05.19/* .

ln -sf $RESTART_DIR/atmosphere/restart_dump.astart .

cd $WORKDIR/atmosphere
ln -sf $TOPDIR/atmosphere/* .
ln -sf $WORKDIR/coupler/* .
rm namelists
sed "s/NDAYS/$NDAYS/" $TOPDIR/atmosphere/namelists > namelists

mkdir -p $WORKDIR/ocean/INPUT
mkdir -p $WORKDIR/ocean/RESTART
cd $WORKDIR/ocean/INPUT
ln -sf $RESTART_DIR/ocean/* .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/ocean/biogeochemistry/global.1deg/2020.05.19/dust.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/ocean/biogeochemistry/global.1deg/2020.05.19/ocmip2_press_monthly_om1p5_bc.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/ocean/tides/global.1deg/2020.05.19/roughness_amp.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/ocean/tides/global.1deg/2020.05.19/tideamp.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ocean/shortwave_penetration/global.1deg/2025.06.23/ssw_atten_depth.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ocean/grids/mosaic/global.1deg/2025.07.29/grid_spec.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ocean/grids/mosaic/global.1deg/2025.07.29/ocean_mosaic.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ocean/grids/mosaic/global.1deg/2025.07.29/ocean_hgrid.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ocean/grids/bathymetry/global.1deg/2025.07.29/topog.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ocean/grids/vertical/global.1deg/2025.07.29/ocean_vgrid.nc .

cd $WORKDIR/ocean
ln -sf $TOPDIR/ocean/* .
ln -sf $WORKDIR/coupler/* .
rm input.nml
sed "s/NDAYS/$NDAYS/" $TOPDIR/ocean/input.nml | sed "s/LAYOUT/$OCN_NPROCX, $OCN_NPROCY/" > input.nml

mkdir -p $WORKDIR/ice/INPUT
mkdir -p $WORKDIR/ice/HISTORY
mkdir -p $WORKDIR/ice/RESTART
cd $WORKDIR/ice/INPUT
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ice/grids/global.1deg/2025.07.29/kmt.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p6/modern/share/ice/grids/global.1deg/2025.07.29/grid.nc .
ln -sf /g/data/vk83/prerelease/configurations/inputs/access-esm1p6/modern/share/ice/iceberg/global.1deg/2024.11.08/lice_discharge_iceberg.nc .
ln -sf /g/data/vk83/configurations/inputs/access-esm1p5/modern/share/ice/climatology/global.1deg/2020.05.19/monthly_sstsss.nc .
cd $WORKDIR/ice/RESTART
ln -sf $RESTART_DIR/ice/* .
ln -sf ../o2i.nc .
cd $WORKDIR/ice
ln -sf $TOPDIR/ice/* .
ln -sf $WORKDIR/coupler/* .
rm cice_in.nml
sed "s/NHOURS/$NHOURS/" $TOPDIR/ice/cice_in.nml > cice_in.nml
cat ice_history.nml >> cice_in.nml
rm input_ice.nml
sed "s/NSECONDS/$NSECONDS/" $TOPDIR/ice/input_ice.nml > input_ice.nml

mpirun -wdir $WORKDIR/atmosphere -np $UM_NPES um_hg3.exe : \
       -wdir $WORKDIR/ocean -np $OCN_NPES mom5_access_cm  : \
       -wdir $WORKDIR/ice -np 12 cice_access-esm1.6_360x300_12x1_12p.exe